rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Posts can be read by anyone. 
    // Writes are restricted to prevent cheating.
    match /Posts/{postId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll([
          'mediaUrl', 'mediaType', 'authorId', 'authorName', 'description', 
          'likes', 'likesWeek', 'boostScore', 'creditValue', 'timestamp', 'boostPurchased'
        ]) &&
        request.resource.data.likes == 0 &&
        request.resource.data.likesWeek == 0 &&
        request.resource.data.boostScore == 0 &&
        request.resource.data.creditValue == 0 &&
        request.resource.data.boostPurchased == 0;
        
      allow update: if 
        // Allow liking (increment by 1)
        (request.resource.data.likes == resource.data.likes + 1 &&
         request.resource.data.likesWeek == resource.data.likesWeek + 1) ||
        // Allow boosting
        (request.resource.data.boostScore == resource.data.boostScore + request.resource.data.boostPurchased - resource.data.boostPurchased) ||
        // Allow credit value update
        (request.resource.data.creditValue > resource.data.creditValue);
    }

    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['postId', 'authorName', 'text', 'timestamp']);
    }

    // Like packages are read-only from the client
    match /likePackages/{packageId} {
      allow read: if true;
      allow write: if false;
    }

    // Transactions can be created but not modified
    match /transactions/{transactionId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasOnly([
          'userId', 'postId', 'likeCount', 'uploadCount', 'boostAmount', 'pricePaid', 
          'paypalTxId', 'type', 'timestamp'
        ]) &&
        (request.resource.data.type == 'likePurchase' && request.resource.data.likeCount > 0) ||
        (request.resource.data.type == 'uploadPurchase' && request.resource.data.uploadCount > 0) ||
        (request.resource.data.type == 'boostPurchase' && request.resource.data.boostAmount > 0) ||
        (request.resource.data.type == 'withdraw' && request.resource.data.pricePaid > 0);
      allow update, delete: if false;
    }

    // A user can only read/write their own wallet
    match /wallets/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if true; // Allow wallet creation for new users
    }
  }
}
