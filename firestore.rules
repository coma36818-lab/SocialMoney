rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /Posts/{postId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll([
          'mediaUrl', 'mediaType', 'authorId', 'authorName', 'description', 
          'likes', 'likesWeek', 'boostScore', 'creditValue', 'timestamp', 'boostPurchased'
        ]) &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.likes == 0 &&
        request.resource.data.likesWeek == 0 &&
        request.resource.data.boostScore == 0 &&
        request.resource.data.creditValue == 0 &&
        request.resource.data.boostPurchased == 0 &&
        // Check if a valid upload token exists, created within the last 5 minutes
        exists(/databases/$(database)/documents/uploadCooldowns/$(request.auth.uid)) &&
        request.time - get(/databases/$(database)/documents/uploadCooldowns/$(request.auth.uid)).data.timestamp < duration.value(5, 'm');

      allow update: if 
        // Allow liking (increment by 1)
        (request.resource.data.likes == resource.data.likes + 1 &&
         request.resource.data.likesWeek == resource.data.likesWeek + 1) ||
        // Allow boosting
        (request.resource.data.boostScore == resource.data.boostScore + request.resource.data.boostPurchased - resource.data.boostPurchased) ||
        // Allow credit value update
        (request.resource.data.creditValue > resource.data.creditValue);
    }

    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['postId', 'authorName', 'text', 'timestamp']);
    }

    match /likePackages/{packageId} {
      allow read: if true;
      allow write: if false;
    }

    match /transactions/{transactionId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasOnly([
          'userId', 'postId', 'likeCount', 'uploadCount', 'boostAmount', 'pricePaid', 
          'paypalTxId', 'type', 'timestamp'
        ]) &&
        (request.resource.data.type == 'likePurchase' && request.resource.data.likeCount > 0) ||
        (request.resource.data.type == 'uploadPurchase' && request.resource.data.uploadCount > 0) ||
        (request.resource.data.type == 'boostPurchase' && request.resource.data.boostAmount > 0) ||
        (request.resource.data.type == 'withdraw' && request.resource.data.pricePaid > 0);
      allow update, delete: if false;
    }

    match /wallets/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if true;
    }

    match /uploadCooldowns/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow creation only if no document exists or the last one is older than 24 hours.
      allow create: if request.auth != null && request.auth.uid == userId &&
                    (!exists(/databases/$(database)/documents/uploadCooldowns/$(userId)) ||
                     request.time - get(/databases/$(database)/documents/uploadCooldowns/$(userId)).data.timestamp > duration.value(24, 'h'));
      allow update, delete: if false;
    }
  }
}
